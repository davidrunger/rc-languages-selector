;(function () {
  'use strict';
  var allLanguages = [".QL","0815","360 Assembly","4D","4DOS Batch","6502 Assembly","6800 Assembly","68000 Assembly","8 1/2","80386 Assembly","8051 Assembly","8080 Assembly","8086 Assembly","8th","A+","ABAP","ACL2","ActionScript","Ada","Agda","Agda2","Agena","Aikido","Aime","Algae","ALGOL","ALGOL 60","ALGOL 68","ALGOL W","Alice ML","Alore","AmbientTalk","AmigaE","AMPL","AngelScript","ANT","ANTLR","APL","App Inventor","AppleScript","Applesoft BASIC","Application Master","Apricot","Arbre","Arc","Arendelle","Argile","ARM Assembly","ASP","ASP.Net","AspectC++","AspectJ","Assembly","Asymptote","ATS","AutoHotkey","AutoIt","AWK","Axe","Axiom","Axum","B","B4J","Babel","BASIC","BASIC256","Batch File","Battlestar","BBC BASIC","Bc","BCPL","Befunge","Beta","Biferno","Blast","BlitzMax","BML","Boo","Bori","Brace","Bracmat","Brainf***","Brat","Brlcad","Burlesque","C","C#","C Shell","C++","C++/CLI","C0H","C1R","Caché ObjectScript","CafeOBJ","Caml","Cat","CB80","Cduce","Cecil","Ceylon","Chapel","Chef","CHR","ChucK","Cilk","Cilk++","Clarion","Clay","Clean","Clipper","Clipper/XBase++","CLIPS","Clojure","CMake","COBOL","Cobra","Coco","CoffeeScript","ColdFusion","Commodore BASIC","Common Lisp","Component Pascal","Coq","Crack","Crystal","Curry","D","Dao","Dart","Datalog","Dc","DCL","DDNC","Delphi","Deluge","Diesel","DMS","Dodo0","DWScript","Dylan","Dylan.NET","Déjà Vu","E","EC","EchoLisp","ECL","Eero","Efene","Egison","EGL","EhBASIC","Eiffel","Ela","Elan","ElastiC","Elena","Elisa","Elixir","ELLA","Elm","Emacs Lisp","Epigram","Erlang","ERRE","Es","ESQL","Euler","Euphoria","Ezhil","F","F#","Factor","Falcon","FALSE","Fan","Fancy","Fantom","FAUST","FBSL","FeatureC++","Felix","Ferite","Fexl","Fish","FLORA-2","Florid","FormulaOne","Forth","Fortran","Fortress","FP","FPI","Free Pascal","FreeBASIC","FreeMat","Frege","Friendly interactive shell","Frink","FunL","Gambas","GAP","Gecho","Gema","Gentee","Genyris","GEORGE","Glagol","GLBasic","Glee","GLSL","GML","Gnuplot","Go","Go!","Golfscript","Golo","Goo","Gosu","Gri","Groovy","GUISS","GW-BASIC","Hack","Harbour","Haskell","Haxe","Heron","HicEst","HLA","Hoon","Hope","HQ9+","Hy","HyperTalk","Icon","IDL","Idris","Inform 6","Inform 7","Informix 4GL","Integer BASIC","Intercal","Io","Ioke","Iptscrae","J","Jabaco","Jack","Jacquard Loom","JAMES II/Rule-based Cellular Automata","Java","JavaFX Script","JavaScript","JCL","JoCaml","Joy","Jq","JScript.NET","JudoScript","Julia","K","Kamailio Script","Kaya","KeyList Databasing","Kite","Kitten","KonsolScript","Kotlin","L++","L.in.oleum","LabVIEW","Lang5","Lasso","LaTeX","LC3 Assembly","LFE","Lhogho","Liberty BASIC","LibreOffice Basic","Lily","Lilypond","Limbo","Lisaac","Lisp","LiveCode","LiveScript","LLP","LLVM","Lobster","Locomotive Basic","Logo","Logtalk","LOLCODE","Lolli","Lotus 123 Macro Scripting","LotusScript","Lout","LSE64","LSL","Lua","Lucid","Luck","Lush","Lygon","M4","M680x0","Make","Malbolge","Maple","MAPPER","Mathematica","Mathprog","MATLAB","Maude","Maxima","MAXScript","MBS","ME10 macro","MEL","Mercury","Metafont","Metapost","MGS","MINIL","MIPS Assembly","Mirah","MIRC Scripting Language","Mirelle","ML/I","MLite","MMIX","Modula-2","Modula-3","Mond","Monicelli","Monte","MOO","MoonScript","Morfa","MUF","MUMPS","MySQL","Mython","Mythryl","N/t/roff","Neat","Neko","Nemerle","NetLogo","NetRexx","NewLISP","NewtonScript","Nial","Nice","Nickle","Nim","Nit","Niue","NQP","NSIS","Oberon-2","Objeck","Object Pascal","ObjectIcon","Objective-C","OCaml","Occam","Octave","Oforth","Omega","Onyx","OOC","OOCalc","OoRexx","Opa","OpenC++","OpenEdge/Progress","Openscad","OPL","Order","OxygenBasic","Oxygene","Oz","Panda","Pare","PARI/GP","Pascal","PASM","PDP-11 Assembly","Pentium Assembly","PeopleCode","Perl","Perl 6","Perl5i","Phix","PHL","PHP","PicoLisp","Piet","Pike","PIR","PL/I","PL/M","PL/pgSQL","PL/SQL","PlainTeX","PLUS","PLZ/SYS","Pony","Pop11","PostScript","Potion","POV-Ray","PowerBASIC","Powerbuilder","PowerShell","PPC Assembly","PPL","Processing","ProDOS","Prolog","Protium","PSQL","Pure","Pure Data","PureBasic","Purity","Python","Q","Qi","Qore","QuakeC","Quill","R","Ra","Racket","RapidQ","Rapira","Rascal","Raven","REALbasic","REBOL","Reduce","Refal","Retro","REXX","Rhope","RLaB","RLSL","RPG","RPGIV","RPL/2","RTL/2","RTSL","Ruby","Rubylog","Run BASIC","Rust","S-lang","Sage","Salmon","SAS","Sather","Scala","Scheme","Scilab","Scratch","Script Basic","Script3D","ScriptBasic","Sed","Seed7","Self","SETL","SheerPower 4GL","Shen","Shiny","Sidef","SIMPOL","Simula","Sisal","Slate","Smalltalk","SMEQL","SmileBASIC","Snobol","SNOBOL4","SNUSP","Soar","SoneKing Assembly","SPARC Assembly","SPARK","Sparkling","SQL","Squirrel","Standard ML","Star","StreamIt","Suneido","Superbase BASIC","SuperCollider","Supernova","Swift","SystemVerilog","TAL","Tcl","Teco","TeLa","Terra","TestML","Thistle","Thyrd","TI-83 BASIC","TI-89 BASIC","TIScript","ToffeeScript","Toka","TorqueScript","TPP","Transact-SQL","Trith","True BASIC","TSE SAL","Turing","TUSCRIPT","Twelf","TXR","UC++","Unicon","Uniface","UNIX Shell","UnixPipes","Unlambda","Ursala","UScript","UserRPL","V","Vala","VAX Assembly","VB6","VBA","VBScript","Vedit macro language","Verilog","VHDL","Vim Script","Visual Basic","Visual Basic .NET","Visual FoxPro","Visual Objects","Visual Prolog","Vorpal","Vox","VRML","Wart","Whenever","Whitespace","WML","Wolfram Language","Wollok","Wortel","Wrapl","Wren","X10","X86 Assembly","Xanadu","XBase","XL","Xojo","XPath 2.0","XPL0","XProc","XQuery","XS","XSLT","XSLT 1.0","XSLT 2.0","XTalk","XUL","Ya","Yacas","Yorick","Z80 Assembly","ZED","Zkl","Zonnon","ZPL","ZX Spectrum Basic","ΜC++","МК-61/52","உயிர்/Uyir"];

  var selectedLanguages;
  var languagesTemplateFn;
  // Is the current page caategorized as a Programming Task? Otherwise,
  // we won't want to run the extension.
  var isTaskPage = !!$('#catlinks a[title="Category:Programming Tasks"]').length;
  if (isTaskPage) {
    // User preferences are persisted via localStorage.
    var previouslyStoredLanguages = window.localStorage.selectedLanguages &&
      JSON.parse(window.localStorage.selectedLanguages);
    var showingForm = false;
    selectedLanguages = previouslyStoredLanguages || allLanguages;
    runExtension();
  }

  function runExtension() {
    injectForm();
    window.showOnlySelectedLanguages(selectedLanguages);
  }

  function injectForm() {
    $.get(chrome.extension.getURL('/html/languages-selector.html'), function (template) {
      var extensionTemplateFn = _.template(template);
      var content = extensionTemplateFn({
        showingForm: showingForm,
        showingAllLanguages: allLanguages.length === selectedLanguages.length
      });
      $(content).prependTo('#content');
      render();

      bindHandlers();
    });
  }

  function filteredLanguages(query) {
    var matchingLanguages = [];

    if (typeof query === 'undefined' || query === '') { return allLanguages; }

    allLanguages.forEach(function (language) {
      if (language.toLowerCase().indexOf(query.toLowerCase()) !== -1) {
        matchingLanguages.push(language);
      }
    });

    return matchingLanguages;
  }

  function render(query) {
    renderLanguagesList();
    renderForm(query);
  }

  function renderLanguagesList() {
    var languagesList;
    if (selectedLanguages.length === 0) {
      languagesList = 'No languages.';
    } else if (selectedLanguages.length > 20) {
      languagesList = selectedLanguages.length + ' languages';
    } else {
      languagesList = selectedLanguages.sort().join(', ');
    }
    $('#rc-languages-selector #languages-list').text(languagesList);
  }

  function renderForm(query) {
    if (!languagesTemplateFn) {
      $.get(chrome.extension.getURL('/html/languages.html'), function (template) {
        languagesTemplateFn = _.template(template);
        renderForm();
      });
    } else {
      var content = languagesTemplateFn({
        filteredLanguages: filteredLanguages(query),
        selectedLanguages: selectedLanguages
      });
      $('#rc-languages-selector #languages').html(content);
    }
  }

  function bindHandlers() {
    $('#rc-languages-selector #toggle-form').click(function (event) {
      event.preventDefault();
      showingForm = !showingForm;
      this.innerText = showingForm ? 'Hide Form' : 'Select Languages';
      $('#rc-languages-selector form').toggleClass('rcls-hidden');
    });

    $('#rc-languages-selector #clear-filter').click(function (event) {
      event.preventDefault();
      $('#rc-languages-selector #search').val('').focus().trigger('input');
    });

    $('#rc-languages-selector #search').on('input', function (event) {
      var query = event.currentTarget.value;
      render(query);
    });

    $("#rc-languages-selector #check-all").change(function (event) {
      $('#rc-languages-selector input:checkbox').not(this).prop('checked', this.checked);
      if (this.checked) {
        selectedLanguages = allLanguages.slice();
      } else {
        selectedLanguages = [];
      }
    });

    // It is important to use event delegation here, as different/new
    // checkboxes will be added to the DOM even after this handler is
    // bound (in response to keystrokes in the filter/search input).
    $('#rc-languages-selector form').on('change', 'input[type="checkbox"]', function (event) {
      if (event.currentTarget.value !== 'show-all') {
        var language = event.currentTarget.value;
        var idx = selectedLanguages.indexOf(language);
        if (event.currentTarget.checked) {
          if (idx === -1) {
            selectedLanguages.push(language);
          }
        } else {
          if (idx !== -1) {
            selectedLanguages.splice(idx, 1);
          }
        }
      }
      window.localStorage.setItem( 'selectedLanguages', JSON.stringify(selectedLanguages) );
      renderLanguagesList();
      window.showOnlySelectedLanguages(selectedLanguages);
    });
  }
}());
